{% extends 'black_invoices/base/base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container-fluid">
    <!-- Mostrar tasa de cambio actual -->
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <strong>Tasa de cambio actual:</strong> 1 USD = {{ ""|tasa_cambio_actual }} VES
        {% if perms.black_invoices.change_tasacambio %}
        <a href="{% url 'black_invoices:tasa_cambio_list' %}" class="btn btn-sm btn-outline-primary ml-2">
            <i class="fas fa-edit"></i> Actualizar
        </a>
        {% endif %}
    </div>
    
    <form method="post" id="formVenta">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">{{ titulo }}</h3>
                    </div>
                    <div class="card-body">
                        <!-- Datos de cliente y método de pago -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Cliente:</label>
                                    <select name="cliente" class="form-control select2" required>
                                        <option value="">------</option>
                                        {% for c in clientes %}
                                            <option value="{{ c.id }}">{{ c.nombre }} {{ c.apellido }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Método de Pago:</label>
                                    <select name="metodo_pag" class="form-control" required id="metodoPago">
                                        <option value="efectivo">Efectivo</option>
                                        <option value="tarjeta">Tarjeta</option>
                                        <option value="transferencia">Transferencia</option>
                                        <option value="credito">Crédito</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Campos del management form crucial para Django -->
                        <input type="hidden" name="form-TOTAL_FORMS" value="1" id="id_form-TOTAL_FORMS">
                        <input type="hidden" name="form-INITIAL_FORMS" value="0" id="id_form-INITIAL_FORMS">
                        <input type="hidden" name="form-MIN_NUM_FORMS" value="0" id="id_form-MIN_NUM_FORMS">
                        <input type="hidden" name="form-MAX_NUM_FORMS" value="1000" id="id_form-MAX_NUM_FORMS">
                        
                        <!-- Tabla de productos -->
                        <h4 class="mt-4">Productos</h4>
                        <div class="table-responsive">
                            <table class="table table-bordered" id="tablaProductos">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Precio</th>
                                        <th>Cantidad</th>
                                        <th>Unidad</th>
                                        <th>Subtotal</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="fila-producto">
                                        <td>
                                            <select name="form-0-producto" class="form-control producto-select" required>
                                                <option value="">------</option>
                                                {% for p in productos %}
                                                    <option value="{{ p.id }}" 
                                                            data-precio="{{ p.precio }}" 
                                                            data-precio-bs="{{ p.precio|precio_bolivares }}" 
                                                            data-stock="{{ p.stock }}"
                                                            data-unidad="{{ p.unidad_medida }}">
                                                        {{ p.nombre }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td class="precio">
                                            <strong>$0.00</strong>
                                            <br><small class="text-muted">0.00 Bs</small>
                                        </td>
                                        <td>
                                            <input type="number" name="form-0-cantidad" class="form-control cantidad" min="0.001" step="0.001" value="1" max="100">
                                        </td>
                                        <td class="unidad">
                                            <span class="text-muted">-</span>
                                        </td>
                                        <td class="subtotal">
                                            <strong>$0.00</strong>
                                            <br><small class="text-muted">0.00 Bs</small>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-danger btn-sm eliminar-fila">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <input type="hidden" name="form-0-tipo_factura" class="tipo-factura-input" value="1">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <button type="button" id="agregarProducto" class="btn btn-info">
                                <i class="fas fa-plus"></i> Agregar Producto
                            </button>
                            <div class="text-right mt-3">
                                <h5>Total: <span id="total">$0.00</span></h5>
                                <h6 class="text-muted">Equivalente: <span id="total-bs">0.00 Bs</span></h6>
                            </div>
                        </div>

                        <!-- Tipo de venta (radio buttons) -->
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">Tipo de Venta</h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="tipo_venta" id="contado" value="contado" checked>
                                            <label class="form-check-label" for="contado">Contado</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="tipo_venta" id="credito" value="credito">
                                            <label class="form-check-label" for="credito">Crédito</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar Venta
                        </button>
                        <a href="{% url 'black_invoices:venta_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Tasa de cambio desde el backend - SIMPLIFICADO
const tasaCambio = 1; // Por ahora usar 1 para debug
console.log('Script cargado, tasa de cambio:', tasaCambio);

// Función para formatear números como moneda USD
function formatCurrency(value, decimals = 4) {
    const num = parseFloat(value) || 0;
    return '$' + num.toFixed(decimals);
}
function updateProductPrice(productSelect) {
    const precio = parseFloat(productSelect.dataset.precio) || 0;
    if (precio < 1) {
        // Para precios menores a $1, mostrar 4 decimales
        return formatCurrency(precio, 4);
    }
    return formatCurrency(precio, 2);
}
// Función para formatear bolívares
function formatBolivares(value) {
    return parseFloat(value).toFixed(2) + ' Bs';
}

// Función para manejar cambios en el select de producto - SIMPLIFICADA
function handleProductChange(event) {
    console.log('=== PRODUCT CHANGE TRIGGERED ===');
    const select = event.target;
    const row = select.closest('.fila-producto');
    
    if (!row) {
        console.error('No se encontró la fila');
        return;
    }
    
    const priceCell = row.querySelector('.precio');
    const quantityInput = row.querySelector('.cantidad');
    const subtotalCell = row.querySelector('.subtotal');
    const unidadCell = row.querySelector('.unidad');
    
    console.log('Elementos encontrados:', {
        priceCell: !!priceCell,
        quantityInput: !!quantityInput,
        subtotalCell: !!subtotalCell,
        unidadCell: !!unidadCell
    });
    
    if (select.selectedIndex > 0) {
        const selectedOption = select.options[select.selectedIndex];
        const price = parseFloat(selectedOption.getAttribute('data-precio')) || 0;
        const stock = parseFloat(selectedOption.getAttribute('data-stock')) || 0;
        const unidad = selectedOption.getAttribute('data-unidad') || 'unidad';
        
        console.log('Datos del producto:', { price, stock, unidad });
        
        if (price > 0) {
            // Actualizar precio mostrado
            const priceBs = price * tasaCambio;
            if (priceCell) {
                priceCell.innerHTML = `<strong>$${price.toFixed(2)}</strong><br><small class="text-muted">${priceBs.toFixed(2)} Bs</small>`;
                console.log('Precio actualizado a:', price);
            }
            
            // Mostrar unidad de medida
            if (unidadCell) {
                unidadCell.innerHTML = `<span class="text-info">${unidad}</span>`;
            }
            
            // Configurar input de cantidad
            if (quantityInput) {
                quantityInput.max = stock;
                if (parseFloat(quantityInput.value) > stock) {
                    quantityInput.value = Math.min(1, stock);
                }
            }
            
            // Calcular subtotal
            updateSubtotal(row);
        }
    } else {
        // Resetear valores
        if (priceCell) priceCell.innerHTML = '<strong>$0.00</strong><br><small class="text-muted">0.00 Bs</small>';
        if (unidadCell) unidadCell.innerHTML = '<span class="text-muted">-</span>';
        if (subtotalCell) subtotalCell.innerHTML = '<strong>$0.00</strong><br><small class="text-muted">0.00 Bs</small>';
        updateTotal();
    }
}

// Función para actualizar subtotal cuando cambia la cantidad
function handleQuantityChange(event) {
    const input = event.target;
    const row = input.closest('.fila-producto');
    
    // Asegurar que la cantidad sea al menos 0.001
    const cantidad = parseFloat(input.value);
    if (cantidad < 0.001 || isNaN(cantidad)) {
        input.value = 0.001;
    }
    
    updateSubtotal(row);
}

// Función simplificada para actualizar subtotal
function updateSubtotal(row) {
    console.log('=== UPDATE SUBTOTAL ===');
    
    const priceCell = row.querySelector('.precio');
    const quantityInput = row.querySelector('.cantidad');
    const subtotalCell = row.querySelector('.subtotal');
    
    if (!priceCell || !quantityInput || !subtotalCell) {
        console.error('Elementos faltantes para calcular subtotal');
        return;
    }
    
    // Extraer precio USD del HTML
    const priceStrongElement = priceCell.querySelector('strong');
    const priceText = priceStrongElement ? priceStrongElement.textContent : '$0.00';
    const price = parseFloat(priceText.replace('$', '')) || 0;
    const quantity = parseFloat(quantityInput.value) || 0;
    
    console.log('Calculando subtotal:', { price, quantity });
    
    const subtotalUSD = price * quantity;
    const subtotalBs = subtotalUSD * tasaCambio;
    
    if (subtotalCell) {
        subtotalCell.innerHTML = `<strong>$${subtotalUSD.toFixed(2)}</strong><br><small class="text-muted">${subtotalBs.toFixed(2)} Bs</small>`;
        console.log('Subtotal actualizado:', subtotalUSD);
    }
    
    // Actualizar el total general
    updateTotal();
}

// Actualizar el total general de la compra (ACTUALIZADA)
function updateTotal() {
    const subtotalCells = document.querySelectorAll('.fila-producto .subtotal');
    let totalUSD = 0;
    
    subtotalCells.forEach(function(cell) {
        const strongElement = cell.querySelector('strong');
        const subtotalText = strongElement ? strongElement.textContent : '$0.00';
        const subtotal = parseFloat(subtotalText.replace('$', '')) || 0;
        totalUSD += subtotal;
    });
    
    const totalBs = totalUSD * tasaCambio;
    
    const totalSpan = document.getElementById('total');
    const totalBsSpan = document.getElementById('total-bs');
    
    if (totalSpan) {
        totalSpan.textContent = formatCurrency(totalUSD);
    }
    if (totalBsSpan) {
        totalBsSpan.textContent = formatBolivares(totalBs);
    }
}

// Eliminar fila de producto
function removeProductRow(event) {
    const button = event.target.closest('.eliminar-fila');
    if (!button) return;
    
    const rows = document.querySelectorAll('.fila-producto');
    if (rows.length > 1) {
        const row = button.closest('.fila-producto');
        row.remove();
        updateTotal();
        updateFormsetManagement();
    } else {
        alert('Debe haber al menos un producto en la venta');
    }
}

// Configurar event listeners para una fila
function setupRowEventListeners(row) {
    const productSelect = row.querySelector('.producto-select');
    if (productSelect) {
        productSelect.addEventListener('change', handleProductChange);
    }
    
    const quantityInput = row.querySelector('.cantidad');
    if (quantityInput) {
        quantityInput.addEventListener('input', handleQuantityChange);
    }
    
    const removeButton = row.querySelector('.eliminar-fila');
    if (removeButton) {
        removeButton.addEventListener('click', removeProductRow);
    }
}

// Actualizar el Management Form de Django
function updateFormsetManagement() {
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');
    if (totalForms) {
        const forms = document.querySelectorAll('.fila-producto');
        totalForms.value = forms.length;
        
        // Renumerar los índices de los formularios
        forms.forEach((form, index) => {
            const inputs = form.querySelectorAll('input[name^="form-"], select[name^="form-"]');
            inputs.forEach(input => {
                const name = input.getAttribute('name');
                if (name) {
                    const newName = name.replace(/form-\d+/, `form-${index}`);
                    input.setAttribute('name', newName);
                }
            });
        });
    }
}

// Sincronizar método de pago con tipo de venta
function setupPaymentSync() {
    const paymentSelect = document.getElementById('metodoPago');
    const cashRadio = document.getElementById('contado');
    const creditRadio = document.getElementById('credito');
    
    // Función para actualizar los tipos de factura
    function updateTipoFactura(isCredit) {
        const tipoFacturaValue = isCredit ? 2 : 1; // 1=contado, 2=crédito
        const inputs = document.querySelectorAll('.tipo-factura-input');
        
        inputs.forEach(input => {
            input.value = tipoFacturaValue;
        });
    }
    
    if (paymentSelect && cashRadio && creditRadio) {
        paymentSelect.addEventListener('change', function() {
            if (this.value === 'credito') {
                creditRadio.checked = true;
                updateTipoFactura(true);
            } else {
                cashRadio.checked = true;
                updateTipoFactura(false);
            }
        });
        
        cashRadio.addEventListener('change', function() {
            if (this.checked) {
                if (paymentSelect.value === 'credito') {
                    paymentSelect.value = 'efectivo';
                }
                updateTipoFactura(false);
            }
        });
        
        creditRadio.addEventListener('change', function() {
            if (this.checked) {
                paymentSelect.value = 'credito';
                updateTipoFactura(true);
            }
        });
    }
}

// Función simplificada para agregar nueva fila
function addProductRow() {
    console.log('=== ADD PRODUCT ROW ===');
    
    const firstRow = document.querySelector('.fila-producto');
    if (!firstRow) {
        console.error('No se encontró la primera fila');
        alert('Error: No se puede agregar producto');
        return;
    }
    
    // Clonar la fila
    const newRow = firstRow.cloneNode(true);
    
    // Resetear valores
    const productSelect = newRow.querySelector('.producto-select');
    const priceCell = newRow.querySelector('.precio');
    const quantityInput = newRow.querySelector('.cantidad');
    const unidadCell = newRow.querySelector('.unidad');
    const subtotalCell = newRow.querySelector('.subtotal');
    
    if (productSelect) productSelect.selectedIndex = 0;
    if (priceCell) priceCell.innerHTML = '<strong>$0.00</strong><br><small class="text-muted">0.00 Bs</small>';
    if (quantityInput) quantityInput.value = 1;
    if (unidadCell) unidadCell.innerHTML = '<span class="text-muted">-</span>';
    if (subtotalCell) subtotalCell.innerHTML = '<strong>$0.00</strong><br><small class="text-muted">0.00 Bs</small>';
    
    // Actualizar nombres de campos
    const rowCount = document.querySelectorAll('.fila-producto').length;
    const inputs = newRow.querySelectorAll('input[name^="form-"], select[name^="form-"]');
    inputs.forEach(input => {
        const name = input.getAttribute('name');
        if (name) {
            const newName = name.replace(/form-\d+/, `form-${rowCount}`);
            input.setAttribute('name', newName);
            console.log('Campo renombrado:', name, '->', newName);
        }
    });
    
    // Agregar la fila a la tabla
    const tbody = document.querySelector('#tablaProductos tbody');
    if (tbody) {
        tbody.appendChild(newRow);
        console.log('Fila agregada exitosamente');
        
        // Configurar event listeners
        setupRowEventListeners(newRow);
        
        // Actualizar formset
        updateFormsetManagement();
    } else {
        console.error('No se encontró tbody');
        alert('Error: No se pudo agregar el producto');
    }
}

// Validación del formulario
function setupFormSubmitValidation() {
    const form = document.getElementById('formVenta');
    
    if (form) {
        form.addEventListener('submit', function(event) {
            // Verificar que hay al menos un producto seleccionado
            const productos = document.querySelectorAll('.producto-select');
            let hayProductosSeleccionados = false;
            
            productos.forEach(select => {
                if (select.selectedIndex > 0) {
                    hayProductosSeleccionados = true;
                }
            });
            
            if (!hayProductosSeleccionados) {
                event.preventDefault();
                alert('Debe seleccionar al menos un producto');
                return false;
            }
            
            // Asegurarse que el formset management está actualizado
            updateFormsetManagement();
            
            // Permitir que el formulario se envíe
            return true;
        });
    }
}

// Inicialización simplificada y con debugging
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOM CONTENT LOADED ===');
    
    // Configurar botón para agregar productos
    const addButton = document.getElementById('agregarProducto');
    if (addButton) {
        addButton.addEventListener('click', function(e) {
            e.preventDefault();
            addProductRow();
        });
        console.log('Botón agregar producto configurado');
    } else {
        console.error('No se encontró el botón agregarProducto');
    }
    
    // Inicializar primera fila
    const firstRow = document.querySelector('.fila-producto');
    if (firstRow) {
        setupRowEventListeners(firstRow);
        console.log('Event listeners configurados para primera fila');
    } else {
        console.error('No se encontró la primera fila');
    }
    
    // Configurar sincronización de método de pago
    setupPaymentSync();
    
    // Configurar validación del formulario
    setupFormSubmitValidation();
    
    // Actualizar management form inicialmente
    updateFormsetManagement();
    
    console.log('=== INICIALIZACIÓN COMPLETA ===');
});
</script> 
{% endblock %}